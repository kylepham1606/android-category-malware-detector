import argparse

import requests
from lxml import html
from main.apk import APK  # from the apk-parse library

GAMES_CATEGORIES = ["Action", "Adventure", "Arcade", "Board", "Card", "Casino", "Casual", "Educational", "Music",
                    "Puzzle", "Racing", "Role Playing", "Simulation", "Sports", "Strategy", "Trivia", "Word"]
GOOGLE_PLAY_BASE_URL = "https://play.google.com/store/apps/details?id="


def main(apk_file):
    print("attempting to get category from Google Play, apk_file={0}".format(apk_file))

    apk_interface = APK(apk_file)
    google_play_response = requests.get(GOOGLE_PLAY_BASE_URL + apk_interface.package)
    html_tree = html.fromstring(google_play_response.content)

    try:
        app_genre = html_tree.xpath('//a[@itemprop="genre"]/text()')[0]
    except Exception:
        print("[ERROR] could not determine category of package " + apk_interface.package)
        app_genre = "Unknown"
    else:
        print("fetched app category, apk_file={0}, package={1}, category={2}".format(
            apk_file, apk_interface.package, app_genre))

    if app_genre in GAMES_CATEGORIES:
        print("simplifying '{0}' to 'Games'".format(app_genre))
        app_genre = "Games"

    return app_genre


if __name__ == "__main__":
    arg_parser = argparse.ArgumentParser()
    arg_parser.add_argument("apk_file", help="APK file path")
    args = arg_parser.parse_args()

    main(args.apk_file)
