import argparse
import json
import os
import shutil
import sys
import time

from android_permission_analysis.fetch_google_play_category.__main__ import main as get_category
from android_permission_analysis.permission_analyzer.__main__ import main as analyze_permissions

SKIP_UNKNOWN_CATEGORIES = True


def main(apk_dir):
    error_files = []

    already_analyzed = os.path.join(apk_dir, "completed")
    if not os.path.isdir(already_analyzed):
        os.mkdir(already_analyzed)

    no_category = os.path.join(apk_dir, "no_category")
    if not os.path.isdir(no_category):
        os.mkdir(no_category)

    apk_list = [os.path.join(apk_dir, apk_file) for apk_file in os.listdir(apk_dir) if apk_file.endswith(".apk")]
    for apk_path in apk_list:
        category = get_category(apk_path)

        if category == "Unknown" and SKIP_UNKNOWN_CATEGORIES:
            print("skipping for now...")
            shutil.move(
                apk_path,
                os.path.join(os.path.split(apk_path)[0], "no_category", os.path.split(apk_path)[1])
            )
            time.sleep(5)  # don't accidentally DOS attack Google Play (or have my IP reported as a bot)
        else:
            try:
                analyze_permissions(apk_path, category)
            except Exception:
                # wait and try again
                print("failed to analyze permissions for {0}, perhaps VirusTotal is still running".format(apk_path))
                print("waiting 30 seconds then trying again...")
                time.sleep(30)
                try:
                    analyze_permissions(apk_path, category)
                except Exception:
                    error_files.append(apk_path)

            shutil.move(
                apk_path,
                os.path.join(os.path.split(apk_path)[0], "completed", os.path.split(apk_path)[1])
            )

    print("files with errors: " + str(error_files))
    return 0


if __name__ == "__main__":
    arg_parser = argparse.ArgumentParser()
    arg_parser.add_argument("apk_dir", help="APK data set directory")
    args = arg_parser.parse_args()

    sys.exit(main(args.apk_dir))
